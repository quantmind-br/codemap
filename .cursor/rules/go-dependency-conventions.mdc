---
description: Specifies Go-specific conventions, strict package dependency boundaries, and the use of the Configuration-Driven Factory Pattern.
globs:
  - "**/*.go"
alwaysApply: false
---

# Go Language Conventions and Dependency Boundaries

This project enforces strict package boundaries and specific error handling patterns to maintain a clean, layered architecture.

## 1. Strict Package Import Rules (Isolation)

To maintain low coupling, external dependencies must be isolated to their respective packages.

- **TUI Isolation:** Only the `@render` package may import `github.com/charmbracelet/bubbletea` or `github.com/charmbracelet/lipgloss`.
- **Parsing Isolation:** Only the `@scanner` package may import `github.com/tree-sitter/go-tree-sitter` or `github.com/ebitengine/purego`.
- **Configuration:** The `@config` package is the sole handler of `gopkg.in/yaml.v3` and environment variable loading. Configuration data is passed as the `*config.Config` struct.

## 2. The analyze.Client Factory Pattern

The `@analyze` package uses a Factory Pattern (`analyze/factory.go`) to manage LLM providers.

- **Rule:** All code outside of `@analyze/factory.go` must interact with LLMs solely through the `analyze.Client` interface.
- **Instantiation:** Use `analyze.NewClient(cfg)` to instantiate the client based on `cfg.LLM.Provider`. Do not directly instantiate concrete clients like `analyze.OpenAIClient{}`.
- **Adapter Pattern:** Concrete client files (e.g., `@analyze/anthropic.go`, `@analyze/gemini.go`) act as adapters, translating the generic `analyze.Client` interface into provider-specific API calls.

## 3. Error Handling and Termination

Error handling differs between the application entry point (`main.go`) and library packages.

- **Library Packages (`scanner`, `graph`, `analyze`):** Must return errors (`error`) for the caller to handle. Never call `os.Exit(1)` or `log.Fatal()` in library code.
- **Entry Point (`main.go`):** Critical errors that prevent command execution must result in immediate termination.
    - **Pattern:**
```go
// Example from main.go run*Mode function
if err := graphStore.Load(); err != nil {
    fmt.Fprintf(os.Stderr, "Fatal: Failed to load graph index. Run 'codemap --index'. Error: %v\n", err)
    os.Exit(1)
}
```